# Development Dockerfile for vlayer client with Foundry setup
FROM ghcr.io/foundry-rs/foundry:latest AS foundry-builder

# Set working directory
WORKDIR /app

# Copy Foundry configuration and source files
COPY foundry.toml .
COPY remappings.txt .
COPY soldeer.lock .
COPY .gitmodules .
COPY src/ src/
COPY script/ script/
COPY test/ test/
COPY lib/ lib/
COPY dependencies/ dependencies/

# Install Foundry dependencies and build contracts
RUN forge install --no-commit
RUN forge build

# Development stage with Node.js
FROM node:18-alpine AS development

# Install system dependencies
RUN apk add --no-cache git python3 make g++ curl

# Set working directory
WORKDIR /app

# Copy the built contracts from foundry stage
COPY --from=foundry-builder /app/out ./out

# Copy package files first for better caching
COPY vlayer/package.json vlayer/bun.lock ./

# Install dependencies
RUN npm install

# Copy configuration files
COPY vlayer/tsconfig.json ./
COPY vlayer/vite.config.ts ./
COPY vlayer/tailwind.config.js ./
COPY vlayer/postcss.config.js ./
COPY vlayer/components.json ./
COPY vlayer/index.html ./

# Copy source code (this will be mounted in development)
COPY vlayer/src/ src/
COPY vlayer/public/ public/

# Expose port for Vite dev server
EXPOSE 5173

# Health check for development
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:5173 || exit 1

# Start development server
CMD ["npm", "run", "web:dev", "--", "--host", "0.0.0.0"] 